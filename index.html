<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Grow Shop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="style.css"> 
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
  <!-- PayPal JS SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=Ab958gA183gsQzVGClcGqW98tY6b1OIXXokzvMhsO1iXpTahhi1ETjmPopZkH82j0skdngxKbHTkLS_r&currency=USD"></script>
  <style>
    .roblox-profile-preview {
      background: #232323;
      margin-top: 12px;
      border-radius: 7px;
      padding: 16px 20px;
      min-height: 70px;
      display: flex;
      align-items: center;
      box-shadow: 0 2px 8px #0002;
      font-size: 1.16em;
      color: #fff;
    }
    .roblox-profile-preview img {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      margin-right: 16px;
      background: #111;
      object-fit: cover;
      border: 2px solid #d9ad57;
    }
    .roblox-profile-preview .username {
      font-weight: 700;
      color: #ffd700;
      font-size: 1.18em;
      margin-right: 8px;
    }
    .roblox-profile-preview .error {
      color: #e15679;
      font-weight: 500;
    }
  </style>

  <script type="module">
// ...your Firebase and other code...

// Roblox Profile Preview using your proxy!
const robloxInput = document.getElementById('robloxUsername');
const robloxProfilePreview = document.getElementById('robloxProfilePreview');

robloxInput.addEventListener('input', async function() {
  const username = robloxInput.value.trim();
  robloxProfilePreview.innerHTML = '';
  if (!username) return;
  robloxProfilePreview.innerHTML = '<span style="color:#bbb">Loading...</span>';
  try {
    // Use your local proxy!
  const res = await fetch('https://688f241798a3e500087df8a0--tranquil-sprinkles-488bbb.netlify.app/.netlify/functions/roblox-lookup', {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ username })
});
const data = await res.json();
    if (!data.data || !data.data[0]) throw 0;
    const user = data.data[0];
    const avatarRes = await fetch(`https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${user.id}&size=100x100&format=Png`);
    const avatarData = await avatarRes.json();
    const imgUrl = avatarData.data[0]?.imageUrl;
    robloxProfilePreview.innerHTML = `
      <a href="https://www.roblox.com/users/${user.id}/profile" target="_blank" title="View Roblox Profile" style="display:flex;align-items:center;text-decoration:none;">
        <img src="${imgUrl}" alt="" />
        <span class="username">${user.username}</span>
      </a>
    `;
  } catch {
    robloxProfilePreview.innerHTML = `<span class="error">User not found or banned.</span>`;
  }
});
// ...rest of your JS code...
</script>
</head>
<body>
  <header class="shop-header">
    <span class="brand">
      <img src="your-logo.png" class="brand-logo" alt="Grow Shop Logo">
      GROW CART
    </span>
    <button class="hamburger" aria-label="Menu" id="hamburgerBtn">&#9776;</button>
    <nav class="shop-nav" id="shopNav">
      <a href="#" id="navHome">Home</a>
      <a href="#" id="navShop">Shop</a>
      <a href="#" id="navAbout">About</a>
      <a href="#" id="navContact">Contact</a>
    </nav>
    <button class="cart-fab" id="cartFab" aria-label="View cart">
      ðŸ›’
      <span class="cart-count">0</span>
    </button>
  </header>

  <div class="cart-drawer" id="cartDrawer" tabindex="-1">
    <button class="cart-close-btn" id="cartCloseBtn" aria-label="Close cart">&times;</button>
    <h2>Your Cart</h2>
    <div id="cartItems"></div>
    <div class="cart-total" id="cartTotal"></div>

    <form id="userInfoForm" autocomplete="off" style="margin:1em 0;">
      <label style="font-size:.99em;display:block;margin-bottom:4px;">Roblox Username</label>
      <input type="text" id="robloxUsername" required style="width:100%;font-size:1.15em;padding:10px;border-radius:6px;margin-bottom:0.5em;background:#222;color:#fff;border:2px solid #333;">
      <label style="font-size:.99em;display:block;margin-top:18px;margin-bottom:4px;">Email</label>
      <input type="email" id="userEmail" required style="width:100%;font-size:1.15em;padding:10px;border-radius:6px;margin-bottom:0.5em;background:#222;color:#fff;border:2px solid #333;">
      <div id="robloxProfilePreview" class="roblox-profile-preview" style="margin-top:20px;"></div>
    </form>
    <div id="paypal-button-container" style="margin:16px 0;"></div>
  </div>
  
  <section class="hero-trendings-section">
    <div id="home" class="trendings-title">Trending Now!</div>
    <div class="trendings-scroll" id="trendingsScroll"></div>
  </section>

  <div id="about" class="website-description">
    <b>Retro Mart</b> is the official website marketplace by <b>Tenz</b> for our beloved players.<br><br>
    Here, Niger players can safely buy, gain points, and discover unique in-game items, pets, and more to enhance their niger game.<br><br>
    Shop with confidence, trade with friends, and help your garden flourish!
  </div>

  <div class="main-content">
    <aside class="sidebar" id="sidebar">
      <div class="sidebar-title">Categories</div>
      <!-- Category buttons dynamically added by JS -->
    </aside>
    <section id="shop" class="products-area">
      <div class="products-title">Featured Products</div>
      <div class="product-grid" id="productGrid">
        <!-- Product cards dynamically added by JS -->
      </div>
    </section>
  </div>

  <footer class="shop-footer" id="contact">
    <div class="footer-content">
      <span>&copy; 2023 Retro Mart. All rights reserved.</span>
      <div>
        <span>Follow us:</span>
        <a href="https://twitter.com/your_twitter" class="social-link" target="_blank" aria-label="Twitter">
          <img src="Assets/contacts/x.svg" alt="Twitter" class="footer-icon">
        </a>
        <a href="https://instagram.com/your_instagram" class="social-link" target="_blank" aria-label="Instagram">
          <img src="Assets/contacts/instagram.svg" alt="Instagram" class="footer-icon">
        </a>
        <a href="https://facebook.com/your_facebook" class="social-link" target="_blank" aria-label="Facebook">
          <img src="Assets/contacts/facebook.svg" alt="Facebook" class="footer-icon">
        </a>
        <a href="https://discord.gg/your_discord" class="social-link" target="_blank" aria-label="Discord">
          <img src="Assets/contacts/discord.svg" alt="Discord" class="footer-icon">
        </a>
      </div>
    </div>
  </footer>

  <!-- Firebase Firestore integration as ES Modules -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC8ciuAyBxAEx29yeK756dhdrKI9ebD9gQ",
      authDomain: "growcart-19ffd.firebaseapp.com",
      projectId: "growcart-19ffd",
      storageBucket: "growcart-19ffd.appspot.com",
      messagingSenderId: "373536744308",
      appId: "1:373536744308:web:5e43d8462dcd7f28e08221",
      measurementId: "G-Q4JDQ62CMF"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const ASSETS_PATH = "Assets/contacts/";
    let categories = [];
    let products = [];

    // --- Load categories and products from Firestore ---
    function renderCategoriesSidebar() {
      const sidebar = document.getElementById('sidebar');
      sidebar.innerHTML = '<div class="sidebar-title">Categories</div>';
      // "All" button
      const allBtn = document.createElement('button');
      allBtn.className = 'sidebar-btn active';
      allBtn.dataset.category = 'all';
      allBtn.textContent = 'All';
      sidebar.appendChild(allBtn);

      allBtn.onclick = () => {
        document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
        allBtn.classList.add('active');
        renderProductsGrid('all');
      };

      categories.forEach(cat => {
        const btn = document.createElement('button');
        btn.className = 'sidebar-btn';
        btn.dataset.category = cat.id;
        btn.textContent = cat.name;
        btn.onclick = () => {
          document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          renderProductsGrid(cat.id);
        };
        sidebar.appendChild(btn);
      });
    }

    function renderProductsGrid(filterCat = 'all') {
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';
      products.forEach(prod => {
        if (filterCat !== 'all' && prod.category !== filterCat) return;
        const card = document.createElement('div');
        card.className = 'product-card';
        card.dataset.category = prod.category;
        card.dataset.id = prod.id;
        card.dataset.title = prod.name;
        card.dataset.price = prod.price;
        card.dataset.img = ASSETS_PATH + prod.image;

        card.innerHTML = `
          <div class="product-img-box">
            <img src="${ASSETS_PATH + prod.image}" alt="${prod.name}" class="product-img">
            <div class="img-placeholder" style="display:none;"><span>${prod.name}</span></div>
          </div>
          <div class="product-main-title">${prod.name}</div>
          <div class="product-price">$${prod.price}</div>
          <button class="product-btn">Add to Cart</button>
        `;
        grid.appendChild(card);
      });

      // Add robust image onerror handler after rendering
      document.querySelectorAll('.product-img').forEach(img => {
        img.onerror = function() {
          this.style.display = 'none';
          var p = this.parentNode.querySelector('.img-placeholder');
          if (p) p.style.display = 'flex';
        };
      });

      // Re-attach listeners
      document.querySelectorAll('.product-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const card = btn.closest('.product-card');
          const id = card.getAttribute('data-id');
          const title = card.getAttribute('data-title');
          const price = parseFloat(card.getAttribute('data-price'));
          const img = card.getAttribute('data-img');
          if(cart[id]) cart[id].qty += 1;
          else cart[id] = {id, title, price, img, qty: 1};
          updateCartDisplayWithPayPal();
        });
      });
    }

    function renderTrendingProducts() {
      const trendingsScroll = document.getElementById('trendingsScroll');
      trendingsScroll.innerHTML = '';
      products.filter(p => p.trending).forEach((prod, idx) => {
        const card = document.createElement('div');
        card.className = 'trending-card';
        card.innerHTML = `
          <div style="position:relative;width:95%;height:90px;">
            <img src="${ASSETS_PATH + prod.image}" alt="Trending ${idx+1}" class="product-img">
            <div class="img-placeholder" style="display:none;">Trend<br>${idx+1}</div>
          </div>
          <div class="trending-card-title">${prod.name}</div>
          <div class="trending-card-price">$${prod.price}</div>
        `;
        trendingsScroll.appendChild(card);
      });

      document.querySelectorAll('.product-img').forEach(img => {
        img.onerror = function() {
          this.style.display = 'none';
          var p = this.parentNode.querySelector('.img-placeholder');
          if (p) p.style.display = 'flex';
        };
      });
    }

    // Firestore live sync
    onSnapshot(collection(db, "categories"), snapshot => {
      categories = [];
      snapshot.forEach(docSnap => {
        categories.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderCategoriesSidebar();
      renderProductsGrid(document.querySelector('.sidebar-btn.active')?.dataset.category || 'all');
    });

    onSnapshot(collection(db, "products"), snapshot => {
      products = [];
      snapshot.forEach(docSnap => {
        products.push({ id: docSnap.id, ...docSnap.data() });
      });
      renderProductsGrid(document.querySelector('.sidebar-btn.active')?.dataset.category || 'all');
      renderTrendingProducts();
    });

    // --- Cart code ---
    let cart = {};
    const cartFab = document.getElementById('cartFab');
    const cartDrawer = document.getElementById('cartDrawer');
    const cartCloseBtn = document.getElementById('cartCloseBtn');
    const cartItemsDiv = document.getElementById('cartItems');
    const cartTotalDiv = document.getElementById('cartTotal');
    // form fields
    const robloxInput = document.getElementById('robloxUsername');
    const robloxProfilePreview = document.getElementById('robloxProfilePreview');
    const userEmail = document.getElementById('userEmail');

    function updateCartDisplay() {
      let count = 0;
      let total = 0;
      cartItemsDiv.innerHTML = '';
      Object.values(cart).forEach(item => {
        count += item.qty;
        total += item.qty * item.price;
      });
      document.querySelectorAll('.cart-count').forEach(span => {
        span.textContent = count;
      });

      if(count === 0) {
        cartItemsDiv.innerHTML = '<div class="cart-empty">Your cart is empty!</div>';
        cartTotalDiv.textContent = '';
        renderPayPalButton(); // Ensure PayPal button is cleared when cart is empty
        return;
      }
      Object.values(cart).forEach(item => {
        const el = document.createElement('div');
        el.className = 'cart-item';
        el.innerHTML = `
          <div style="position:relative;width:48px;height:48px;">
            <img class="cart-item-img" src="${item.img}" alt="${item.title}">
            <div class="img-placeholder" style="display:none;"><span>${item.title}</span></div>
          </div>
          <div class="cart-item-title">${item.title}</div>
          <div class="cart-item-price">$${(item.price*item.qty).toFixed(2)}</div>
          <button class="cart-remove-btn" data-id="${item.id}">&times;</button>
        `;
        cartItemsDiv.appendChild(el);
      });

      // Robust image error handler
      document.querySelectorAll('.cart-item-img').forEach(img => {
        img.onerror = function() {
          this.style.display = 'none';
          var p = this.parentNode.querySelector('.img-placeholder');
          if (p) p.style.display = 'flex';
        };
      });

      cartTotalDiv.textContent = `Total: $${total.toFixed(2)}`;
      Array.from(cartItemsDiv.querySelectorAll('.cart-remove-btn')).forEach(btn => {
        btn.onclick = () => {
          const id = btn.getAttribute('data-id');
          delete cart[id];
          updateCartDisplayWithPayPal();
        };
      });
    }

    cartFab.onclick = () => { cartDrawer.classList.add('open'); };
    cartCloseBtn.onclick = () => { cartDrawer.classList.remove('open'); };

    // --- Roblox Profile Preview ---
    robloxInput.addEventListener('input', async function() {
      const username = robloxInput.value.trim();
      robloxProfilePreview.innerHTML = '';
      if (!username) return;
      robloxProfilePreview.innerHTML = '<span style="color:#bbb">Loading...</span>';
      try {
        // Get Roblox userId and info
        const res = await fetch(`https://users.roblox.com/v1/usernames/users`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ usernames: [username], excludeBannedUsers: true })
        });
        const data = await res.json();
        if (!data.data || !data.data[0]) throw 0;
        const user = data.data[0];
        const avatarRes = await fetch(`https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${user.id}&size=100x100&format=Png`);
        const avatarData = await avatarRes.json();
        const imgUrl = avatarData.data[0]?.imageUrl;
        robloxProfilePreview.innerHTML = `
          <a href="https://www.roblox.com/users/${user.id}/profile" target="_blank" title="View Roblox Profile" style="display:flex;align-items:center;text-decoration:none;">
            <img src="${imgUrl}" alt="" />
            <span class="username">${user.username}</span>
          </a>
        `;
      } catch {
        robloxProfilePreview.innerHTML = `<span class="error">User not found or banned.</span>`;
      }
    });

    // --- Firestore & Discord webhook ---
    async function firestoreOrder(order) {
      await addDoc(collection(db, "orders"), {
        ...order,
        created: serverTimestamp(),
      });
    }

    async function sendDiscordWebhook(order) {
      // Replace with your own webhook
      const webhookUrl = "YOUR_DISCORD_WEBHOOK_URL";
      await fetch(webhookUrl, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          content: `**New Order!**
**Roblox:** ${order.robloxUsername}
**Email:** ${order.email}
**Items:** ${order.items.map(i=>`\`${i.title}\` x${i.qty}`).join(", ")}
**Total:** $${order.total}`
        })
      });
    }

    // --- PayPal Integration ---
    function getCartItemsArray() {
      return Object.values(cart).map(item => ({
        name: item.title,
        unit_amount: { currency_code: "USD", value: item.price.toFixed(2) },
        quantity: item.qty.toString()
      }));
    }
    function getCartTotal() {
      return Object.values(cart).reduce((sum, item) => sum + item.price * item.qty, 0).toFixed(2);
    }
    function renderPayPalButton() {
      const btnDiv = document.getElementById('paypal-button-container');
      btnDiv.innerHTML = '';
      if (Object.keys(cart).length === 0) return;
      if (typeof paypal === "undefined" || !btnDiv) {
        setTimeout(renderPayPalButton, 200);
        return;
      }
      paypal.Buttons({
        createOrder: function(data, actions) {
          // Validate form
          if (!robloxInput.value.trim() || !userEmail.value.trim()) {
            alert("Please enter your Roblox username and email.");
            return;
          }
          return actions.order.create({
            purchase_units: [{
              amount: {
                currency_code: "USD",
                value: getCartTotal(),
                breakdown: {
                  item_total: { currency_code: "USD", value: getCartTotal() }
                }
              },
              items: getCartItemsArray()
            }]
          });
        },
        onApprove: function(data, actions) {
          return actions.order.capture().then(async function(details) {
            // Send to Firestore and Discord
            const order = {
              robloxUsername: robloxInput.value.trim(),
              email: userEmail.value.trim(),
              items: Object.values(cart),
              total: getCartTotal(),
              paypalOrderId: data.orderID,
              payer: details.payer,
            };
            await firestoreOrder(order);
            await sendDiscordWebhook(order);
            alert("Payment complete! Thank you, " + details.payer.name.given_name + ".");
            cart = {};
            updateCartDisplayWithPayPal();
            robloxInput.value = "";
            userEmail.value = "";
            robloxProfilePreview.innerHTML = "";
          });
        }
      }).render('#paypal-button-container');
    }
    function updateCartDisplayWithPayPal() {
      updateCartDisplay();
      renderPayPalButton();
    }
    window.updateCartDisplay = updateCartDisplayWithPayPal;
    document.addEventListener('DOMContentLoaded', updateCartDisplayWithPayPal);

    // --- SMOOTH NAVIGATION WITH CUSTOM ANIMATION ---
    function slowScrollToElement(targetId, offset = 0, duration = 1000) {
      const target = document.getElementById(targetId);
      if (!target) return;
      const headerOffset = document.querySelector('header').offsetHeight || 0;
      const elementPosition = target.getBoundingClientRect().top + window.pageYOffset - headerOffset + offset;
      const startPosition = window.pageYOffset;
      const distance = elementPosition - startPosition;
      let start = null;

      function easeInOutQuad(t, b, c, d) {
        t /= d/2;
        if (t < 1) return c/2*t*t + b;
        t--;
        return -c/2 * (t*(t-2) - 1) + b;
      }

      function animateScroll(timestamp) {
        if (!start) start = timestamp;
        const elapsed = timestamp - start;
        const run = easeInOutQuad(elapsed, startPosition, distance, duration);
        window.scrollTo(0, run);
        if (elapsed < duration) {
          requestAnimationFrame(animateScroll);
        } else {
          window.scrollTo(0, elementPosition);
        }
      }
      requestAnimationFrame(animateScroll);
    }
    document.getElementById('navHome').addEventListener('click', function(e) {
      e.preventDefault(); slowScrollToElement('home', 0, 800);
    });
    document.getElementById('navShop').addEventListener('click', function(e) {
      e.preventDefault(); slowScrollToElement('shop', 0, 800);
    });
    document.getElementById('navAbout').addEventListener('click', function(e) {
      e.preventDefault(); slowScrollToElement('about', 0, 800);
    });
    document.getElementById('navContact').addEventListener('click', function(e) {
      e.preventDefault(); slowScrollToElement('contact', 0, 800);
    });

    // --- Cart Empty Animation ---
    function animateCartEmpty() {
      cartDrawer.classList.remove('cart-empty-anim');
      void cartDrawer.offsetWidth;
      cartDrawer.classList.add('cart-empty-anim');
      setTimeout(() => { cartDrawer.classList.remove('cart-empty-anim'); }, 700);
      cartDrawer.focus && cartDrawer.focus();
    }
  </script>
  <style>
    .cart-drawer.cart-empty-anim {
      animation: cartShake 0.42s cubic-bezier(.36,.07,.19,.97) both;
      border-left: 3px solid #d18484 !important;
      box-shadow: -8px 0 24px #e156796c, 0 0 0 4px #fff8e1 inset;
    }
    @keyframes cartShake {
      10%, 90% { transform: translateX(-2px); }
      20%, 80% { transform: translateX(4px); }
      30%, 50%, 70% { transform: translateX(-8px); }
      40%, 60% { transform: translateX(8px); }
      100% { transform: translateX(0); }
    }
  </style>
</body>
</html>